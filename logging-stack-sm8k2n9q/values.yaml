fluent-bit:
  image:
    repository: cr.fluentbit.io/fluent/fluent-bit
    # Overrides the image tag whose default is {{ .Chart.AppVersion }}
    # Set to "-" to not use the default value
    tag: 2.2.1
    pullPolicy: IfNotPresent

  fullnameOverride: "fluent-bit"

  resources: {}

  luaScripts:
    dedot_k8s.lua: |
      function dedot(tag, timestamp, record)
          if record["kubernetes"] == nil then
              return 0, 0, 0
          end
          if (record["kubernetes"]["labels"]["app"] ~= nil and type(record["kubernete"]["labels"]["app"]) ~= "table") then
              record["kubernetes"]["labels"]["app"] = {appName = record["kubernetes"]["labels"]["app"]}
          end
          dedot_keys(record["kubernetes"]["annotations"])
          dedot_keys(record["kubernetes"]["labels"])
          return 1, timestamp, record
      end

      function dedot_keys(map)
          if map == nil then
              return
          end
          local new_map = {}
          local changed_keys = {}
          for k, v in pairs(map) do
              local deslashed = string.gsub(k, "%/", "_")
              local dedotted = string.gsub(deslashed, "%.", "_")
              if dedotted ~= k then
                  new_map[dedotted] = v
                  changed_keys[k] = true
              end
          end
          for k in pairs(changed_keys) do
              map[k] = nil
          end
          for k, v in pairs(new_map) do
              map[k] = v
          end
      end

  config:
    service: |
      [SERVICE]
          Daemon Off
          Flush {{ .Values.flush }}
          Log_Level {{ .Values.logLevel }}
          Parsers_File /fluent-bit/etc/parsers.conf
          Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
          Parsers_File /fluent-bit/etc/conf/parsers_multiline.conf
          HTTP_Server On
          HTTP_Listen 0.0.0.0
          HTTP_Port {{ .Values.metricsPort }}
          Health_Check On

    ## https://docs.fluentbit.io/manual/pipeline/inputs
    inputs: |
      [INPUT]
          Name tail
          Path /var/log/containers/*.log
          multiline.parser docker, cri, multiline-regex
          Tag kube.*
          Mem_Buf_Limit 5MB
          Skip_Long_Lines On

      [INPUT]
          Name systemd
          Tag host.*
          Systemd_Filter _SYSTEMD_UNIT=kubelet.service
          Read_From_Tail On

    ## https://docs.fluentbit.io/manual/pipeline/filters
    filters: |
      [FILTER]
          Name kubernetes
          Match kube.*
          Merge_Log On
          Keep_Log Off
          K8S-Logging.Parser On
          K8S-Logging.Exclude On

      [FILTER]
          Name lua
          Match kube.*
          script /fluent-bit/scripts/dedot_k8s.lua
          call dedot

    ## https://docs.fluentbit.io/manual/pipeline/outputs
    outputs: |
      [OUTPUT]
          Name opensearch
          Match kube.*
          Host opensearch-cluster-master
          Port 9200
          HTTP_User admin
          HTTP_Passwd admin
          tls On
          tls.verify Off
          Suppress_Type_Name On
          Logstash_Format On
          Logstash_Prefix fluentbit
          Replace_Dots On
          Generate_ID On
          Write_Operation upsert
          Trace_Error On

    # This allows adding more files with arbitary filenames to /fluent-bit/etc/conf by providing key/value pairs.
    # The key becomes the filename, the value becomes the file content.
    extraFiles:
      parsers_multiline.conf: |
        [MULTILINE_PARSER]
          name          multiline-regex
          type          regex
          flush_timeout 1000
          rule "start_date" "/(\[\d+\/\d+\/\d+)(.*)/" "cont"
          rule "cont"       "/^\s+at.*/"              "cont"

fluentd:
  fullnameOverride: "fluentd"

  image:
    repository: "fluent/fluentd-kubernetes-daemonset"
    tag: ""

  resources: {}

opensearch:
  singleNode: true

  # if not set, falls back to parsing .Values.imageTag, then .Chart.appVersion.
  majorVersion: "2.11.1"

  # such as opensearch.yml and log4j2.properties
  config:
    opensearch.yml: |
      cluster.name: opensearch-cluster
      compatibility.override_main_response_version: true

      # Bind to all interfaces because we don't know what IP address Docker will assign to us.
      network.host: 0.0.0.0

      # Setting network.host to a non-loopback address enables the annoying bootstrap checks. "Single-node" mode disables them again.
      # Implicitly done if ".singleNode" is set to "true".
      discovery.type: single-node

      # Start OpenSearch Security Demo Configuration
      # WARNING: revise all the lines below before you go into production
      plugins:
        security:
          ssl:
            transport:
              pemcert_filepath: esnode.pem
              pemkey_filepath: esnode-key.pem
              pemtrustedcas_filepath: root-ca.pem
              enforce_hostname_verification: false
            http:
              enabled: true
              pemcert_filepath: esnode.pem
              pemkey_filepath: esnode-key.pem
              pemtrustedcas_filepath: root-ca.pem
          allow_unsafe_democertificates: true
          allow_default_init_securityindex: true
          authcz:
            admin_dn:
              - CN=kirk,OU=client,O=client,L=test,C=de
          audit.type: internal_opensearch
          enable_snapshot_restore_privilege: true
          check_snapshot_restore_write_privileges: true
          restapi:
            roles_enabled: ["all_access", "security_rest_api_access"]
          system_indices:
            enabled: true
            indices:
              [
                ".opendistro-alerting-config",
                ".opendistro-alerting-alert*",
                ".opendistro-anomaly-results*",
                ".opendistro-anomaly-detector*",
                ".opendistro-anomaly-checkpoints",
                ".opendistro-anomaly-detection-state",
                ".opendistro-reports-*",
                ".opendistro-notifications-*",
                ".opendistro-notebooks",
                ".opendistro-asynchronous-search-response*",
              ]
      ######## End OpenSearch Security Demo Configuration ########

  image:
    repository: "opensearchproject/opensearch"
    # override image tag, which is .Chart.AppVersion by default
    tag: "2.11.1"

  opensearchJavaOpts: "-Xmx512M -Xms512M"

  resources:
    requests:
      cpu: "1000m"
      memory: "1Gi"
    limits:
      cpu: "1000m"
      memory: "1Gi"

  persistence:
    storageClass: "nfs-retain-app"

  fullnameOverride: "opensearch"

opensearch-dashboards:
  opensearchHosts: "https://opensearch-cluster-master:9200"
  replicaCount: 1

  image:
    repository: "opensearchproject/opensearch-dashboards"
    # override image tag, which is .Chart.AppVersion by default
    tag: "2.11.1"

  fullnameOverride: "opensearch-dashboards"

  resources:
    requests:
      cpu: "100m"
      memory: "512M"
    limits:
      cpu: "100m"
      memory: "512M"

  service:
    port: 5601